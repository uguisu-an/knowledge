所持ポイントを使っていいかどうかを判定するのは、データベースをトランザクションで更新して、コミットする直前にもう一度確かめたほうがいい。
所持ポイントをマイナスするレコードを記録して、集計し直したときに 0 未満になっていたら足りてない。
事前の所持ポイントチェックだと読み取りの時から排他ロックしないといけなくなるので、集計時に確かめたほうがいいはず。
