# SSE (Server-Sent Event)

プッシュ通知の実装に使うことがある。

サーバーに接続したままにするロングポーリングの実装の一種。

WebSocket と違って、サーバーから送られるイベントをクライアントが受け取るだけの単方向の仕組み。
クライアントからサーバーへの情報送信は SSE とは別に普通の API アクセスとして実装すればいい。

SSE のエンドポイントを/events だけに共通化する場合、内部でポーリングする代わりに Redis などを subscribe して共通のイベントを拾う必要がある。

SSE などで新しいメッセージを待つ場合、最新の id を持っておいて、where("id", ">", $recentMessageId) すれば新しいものだけ取れる。

SSE のエンドポイントは/events 一つで、そこにイベントだけ投げるのがいいと思う。それ以上の情報はあらためて API を叩けばいい。

ショートポーリングや SSE で頻繁に更新を確認する場合、DB アクセスを減らすために最新の ID や更新日時をキャッシュした方がいい。

SSE の検証して、Laravel のサーバーで送ったイベントを、ブラウザと NodeJS のクライアントで受け取れるのを確認した。NodeJS 以外でもレスポンスをストリームとして扱える環境なら簡単に作れそう。WebSocket より全然楽。

ブラウザ以外のクライアントを実装する場合、デーモンツールで再起動すれば再接続になる。
ストリームが閉じたり、接続が切れたりしても、クライアントは単に終了すればいい。

自前で SSE のクライアントを用意する場合、stream を受け取って、\n\n で区切って、"data:"で始まる部分をメッセージとして扱えばいい。

改行二つ (\n\n) が特別扱いなので、改行が含まれるテキストは json にして送る。

サーバー側からストリームを閉じると JS の EventSource は再接続するためにエンドポイントを再度呼び出す。

SSE のデータは最後の改行二つも含めて "data: $text\n\n" まで必要。

sse-push で nodejs と laravel の間のプッシュ通知を試せないか。まず laravel で簡単に実装できる？

SSE でも接続が切れたイベントをサーバー側で拾える。
入退室管理だけなら WS の代替として十分に使えそう。

SSE や WS のように接続を維持する方式でないと、接続が切れてもサーバー側で把握できない。
disconnect が保証されないので、ハートビートを送り続けてしばらく届かなかったら退室扱いにするような工夫が必要。

Laravel Echo の場合、WebSocket と言ってもサーバー主導の配信にしか使ってない。
本来は SSE やロングポーリングでもいいはずだけど、PHP の場合はブロッキング IO なのでそれらを使うと接続数の制限が厳しくなってしまう。

ショートポーリングの場合、毎回接続が切れるのでプロセス数の限界を超えても順々に処理すればいいが、ロングポーリングや SSE、WS の場合はプロセス数の限界を迎えると接続できなくなる。

WebSocket のようにタイムラグのない双方向通信が求められることは少ない。
普通は SSE やポーリングで読み取って、API を叩いて書き込めば足りる。

イベントが発生してから通知されるまでラグが少ないのは WebSocket の利点だ。
純粋な PubSub を使えるので、SSE やポーリングのように sleep を挟んでぐるぐるするようなタイムラグがない。

ロングポーリングや SSE でイベントを購読しても、元々の API は残す。

PHP で SSE するときは `ignore_user_abort(true);` して、自前で `connection_aborted()` を拾ってストリームを切らないと、プロセスが残り続ける。

ロングポーリングや SSE を使う代わりに、データ同期のプラットフォームを使うのも手だ。

- Firebase Realtime Database
- Azure Mobile Apps
- MongoDB Realm (Beta)

ショートポーリングは最も原始的なパターンで、代わりにロングポーリングや SSE、WS などを用いることがある。

ロングポーリングはメッセージが多いほどやりとりが増える。
あまり頻繁にやりとりするようならポーリングよりも SSE や WS を採用した方がいいかも。

サーバーからリアルタイムにイベントを受け取りたいだけなら、ショート/ロング・ポーリングや Event Source (あるいは Server-sent Events = SSE)などもある。
WebSocket は双方向通信のプロトコルなので、サーバーから受け取るだけなら単方向通信になって、大袈裟と言えるだろう。
.
